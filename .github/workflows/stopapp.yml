name: Manual SSH Deploy to EC2

on:
  workflow_dispatch:  # manual trigger
  schedule:
    - cron: "35 4 * * *"  # runs at 04:35 UTC daily

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH and connect to EC2
        run: |
          echo "Setting up SSH..."

          # Prepare SSH folder
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Add private key
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Optional: Add host to known_hosts (avoid prompt)
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

          echo "Connecting to EC2 and running commands..."

          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "✅ Connected to EC2 instance"
            cd ~/your-app-folder  # 🔁 Replace with your app path
            git pull origin main || echo "Git repo not found or pull failed"
            docker compose down || docker stop myapp && docker rm myapp
            docker compose up -d --build
            echo "🚀 Deployment finished"
          EOF
